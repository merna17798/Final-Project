/*
 * main.c
 *
 *  Created on: 11 Oct 2020
 *      Author: pc
 */
#include "lcd.h"
#include "keypad.h"
#include "uart.h"
#define READY 255
#define r 100
static void get_pass(char arr[50],uint8 sent_pass[7]){
	uint8 key, i,j;
	LCD_sendCommand(CLEAR_COMMAND);
	LCD_displayStringRowColumn(0,0,arr);
	LCD_goToRowColumn(1,0);
	/* if any switch pressed for more than 500 ms it counts more than one press */
	for (i=0;i<5;i++){
		key = KeyPad_getPressedKey(); /* get the pressed key number */
		_delay_ms(2000); /* Press time  */
		LCD_displayCharacter('*'); /* display the pressed keypad switch */
		sent_pass[i]=key;
	}
	key = KeyPad_getPressedKey(); /* get the pressed key number */
	_delay_ms(2000); /* Press time  */
	while (key!=13){
		LCD_sendCommand(CLEAR_COMMAND);
    	LCD_displayStringRowColumn(0,0,"Err, press on/c");
    	key = KeyPad_getPressedKey(); /* get the pressed key number */
    	_delay_ms(2000); /* Press time  */
    	j++;
	}
	if (key==13){
		LCD_sendCommand(CLEAR_COMMAND);
	}
}
static void compare(uint8 new_pass[7], uint8 match_pass[7] ){
	uint8 i,j=0;
	for (i=0;i<5;i++){

		if (match_pass[i]==new_pass[i]){
			j++;
		}
	}
	while(j!=5){
		LCD_displayStringRowColumn(0,0,"Not matched!");

    	get_pass("reEnter your PW:",match_pass);
    	j=compare(new_pass,match_pass);
	}
	if(j==5){
		LCD_displayStringRowColumn(0,0,"matched!");
		_delay_ms(1000);
    	UART_sendByte(READY);
    	for(i=0;i<5;i++){
    		while(UART_recieveByte()!=READY){}
    		UART_sendByte(new_pass[i]);
	}
	}
	//return j;
}

int main(void)
{
	uint8 i,j,key
	,new_pass[7],match_pass[7],old_pass[7],match_pass2[7];
	LCD_init();
	UART_init();
	get_pass("Enter your PW:", new_pass);
	_delay_ms(10);
	get_pass("reEnter your PW:",match_pass);
	j=compare(new_pass,match_pass);
	while(j!=5){
    	get_pass("reEnter your PW:",match_pass);
    	j=compare(new_pass,match_pass);
	}
	if (j==5){
    	UART_sendByte(READY);
    	for(i=0;i<5;i++){
    		while(UART_recieveByte()!=READY){}
    		UART_sendByte(new_pass[i]);
    	}
	}
	LCD_displayStringRowColumn(0,0,"Choose option");
	_delay_ms(1000);

    while(1)
    {

		LCD_displayStringRowColumn(0,0,"- open");
		LCD_displayStringRowColumn(1,0,"+ New password");
		_delay_ms(1000);
		key = KeyPad_getPressedKey(); /* get the pressed key number */
		_delay_ms(2000); /* Press time  */
		if (key =='+'){
			get_pass("Enter old PW:", old_pass);
			UART_sendByte(r);
			for(i=0;i<5;i++){
				while(UART_recieveByte()!=r){};
				match_pass2[i]=UART_recieveByte();
				_delay_ms(100);
			}
			j=compare(old_pass,match_pass2);
			while(j!=5){
		    	get_pass("reEnter old PW:",old_pass);
		    	j=compare(old_pass,match_pass2);
			}
			if (j==5){
				get_pass("Enter your PW:", new_pass);
				_delay_ms(10);
				get_pass("reEnter your PW:",match_pass);
				j=compare(new_pass,match_pass);
				while(j!=5){
			    	get_pass("reEnter your PW:",match_pass);
			    	j=compare(new_pass,match_pass);
				}
				if (j==5){
			    	UART_sendByte(READY);
			    	for(i=0;i<5;i++){
			    		while(UART_recieveByte()!=READY){}
			    		UART_sendByte(new_pass[i]);
			    	}
				}
			}


		}

    }

}
